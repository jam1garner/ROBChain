wiiuhaxx_common_path := ../wiiuhaxx_common/wiiu_browserhax_common.php
wiiuhaxx_common_cfg := wiiuhaxx_common_cfg.php
pymsc_asm_py := ../pymsc/asm.py
PYTHON       := python3
ifeq (, $(shell which python3))
	# if no python3 alias, fall back to `python` and hope it's py3
	PYTHON   := python
endif

all: clean exploit.mscsb

clean:
	rm -f exploit.mscsb payload.s main.s

exploit.mscsb: $(pymsc_asm_py) payload.s Scripts main.s
	$(PYTHON) ../pymsc/asm.py

payload.s: payload.bin 
	$(PYTHON) generate_payload.py

main.s: rop_setup.s $(wiiuhaxx_common_cfg) $(wiiuhaxx_common_path)
	php generatepayload.php > main.s

$(pymsc_asm_py):
	if [ -a $(pymsc_asm_py) ]; then $(error missing $(pymsc_asm_py) (git clone recursive)); fi;
    
$(wiiuhaxx_common_path):
	if [ -a $(wiiuhaxx_common_path) ]; then $(error missing $(wiiuhaxx_common_path)); fi;

$(wiiuhaxx_common_cfg):
	if [ -a $(wiiuhaxx_common_cfg) ]; then $(error missing $(wiiuhaxx_common_cfg)); fi;
